require "ui/game/chairList"
require "ui/game/gameBtn"
require "ui/game/identityChoose"
require "ui/game/characterChoose"

local ui = {}
local cacheData = {}
local gameStage = GameStage.WaitStart
                        
local InitUIReference = function()
	ui.gameBtn = GameBtn:New(self.gameObject, ui)
	ui.gameBtn:InitUIReference()
	
	ui.chairList = ChairList:New(self.transform:Find("ChairList").gameObject)
	ui.chairList:InitUIReference()
		
	ui.identityChoose = IdentityChoose:New(self.transform:Find("Identity").gameObject)
	ui.identityChoose:InitUIReference()
	
	ui.characterChoose = CharacterChoose:New(self.transform:Find("CharacterChoose").gameObject)
	ui.characterChoose:InitUIReference()
	
end
	
local InitUI = function()
	ui.gameBtn:InitUI()
	ui.chairList:InitUI()
	ui.identityChoose:InitUI()
	ui.characterChoose:InitUI()
end

local RefreshRoomInfo = function()
	ui.chairList:RefreshRoomInfo()
	ui.gameBtn:RefreshRoomInfo()
end

local AddUIEvent = function()
	ui.gameBtn:AddUIEvent()
	ui.chairList:AddUIEvent()
	ui.identityChoose:AddUIEvent()
	ui.characterChoose:AddUIEvent()
end

local RemoveUIEvent = function()
	ui.gameBtn:RemoveUIEvent()
	ui.chairList:RemoveUIEvent()
	ui.identityChoose:RemoveUIEvent()
	ui.characterChoose:RemoveUIEvent()
end

local OnReceiveRoomInfoChange = function(bytes)
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Room, Global.Protos.Class.RoomInfoChange_S2C, bytes)
	Global.Data.RoomInfo.SetRoomInfo(data.roomInfo)
	Global.Data.RoomInfo.SetChairsInfo(data.chairInfoList)
	RefreshRoomInfo()
end

local OnReceiveExitRoom = function(bytes)
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Room, Global.Protos.Class.ExitRoom_S2C, bytes)
	if data.code == "Success" then
		Global.Data.RoomInfo.Clear()
		UIManager:CloseUI(Global.GamePrefab_Path)
		UIManager:OpenUI(Global.LoginPrefab_Path)
	elseif data.code == "Kick" then
		Global.Methods.ShowTips(data.msg)
		Global.Data.RoomInfo.Clear()
		UIManager:CloseUI(Global.GamePrefab_Path)
		UIManager:OpenUI(Global.LoginPrefab_Path)
	else
		Global.Methods.ShowTips(data.msg)
	end
end

local OnReceiveRequestRoomInfo = function(bytes)
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Room, Global.Protos.Class.RequestRoomInfo_S2C, bytes)
	if data.code == "Success" then
		Global.Data.RoomInfo.SetRoomInfo(data.roomInfo)
		Global.Data.RoomInfo.SetChairsInfo(data.chairInfoList)
		RefreshRoomInfo()
	else
		Global.Methods.ShowTips(data.msg)
	end
end

local OnReceiveReadyStatus = function(bytes)
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Room, Global.Protos.Class.ReadyStatus_S2C, bytes)
	if data.code == "Failed" then
		Global.Methods.ShowTips(data.msg)
	end
end

local OnReceiveCharacterChooseList = function(bytes)
	if gameStage ~= GameStage.WaitCharacterChoose then
		cacheData.CharacterChoose = bytes
		return
	end
	
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Game, Global.Protos.Class.CharacterChooseList_S2C, bytes)
	gameStage = GameStage.CharacterChoose
	EventManager:TriggerEvent(Global.Event.CharacterChooseStart, data)
end

local OnIdentityChooseComplete = function()
	gameStage = GameStage.WaitCharacterChoose
	if cacheData.CharacterChoose ~= nil then
		OnReceiveCharacterChooseList(cacheData.CharacterChoose)
	end
end

local OnReceiveIdentity = function(bytes)
	if gameStage ~= GameStage.WaitIdentityChoose then
		cacheData.IdentityChoose = bytes
		return
	end
	cacheData.IdentityChoose = nil
	
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Game, Global.Protos.Class.Identity_S2C, bytes)
	gameStage = GameStage.IdentityChoose
	EventManager:TriggerEvent(Global.Event.IdentityChooseStart, data)
end

local OnReceiveGameStart = function(bytes)
	if gameStage ~= GameStage.WaitStart then 
		Debug.LogError("lua.game.OnReceiveGameStart 游戏未初始化")
		return 
	end

	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Game, Global.Protos.Class.GameStart_S2C, bytes)
	
	if data.code == "Success" then
		--Global.Methods.ShowTips("游戏开始")
		gameStage = GameStage.WaitIdentityChoose
		EventManager:TriggerEvent(Global.Event.GameStart, nil)
		if cacheData.IdentityChoose ~= nil then
			OnReceiveIdentity(cacheData.IdentityChoose)
		end
	else
		Global.Methods.ShowTips(data.msg)
	end
end

local OnReceiveDealCards = function(bytes)
	if gameStage ~= GameStage.WaitDealCards then
		cacheData.DealCards = bytes
		return
	end
	cacheData.DealCards = nil

	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Game, Global.Protos.Class.DealCards_S2C, bytes)
	gameStage = GameStage.DealCards
	EventManager:TriggerEvent(Global.Event.DealCards, data)
end

local OnCharacterChooseComplete = function()
	gameStage = GameStage.WaitDealCards
	if cacheData.DealCards ~= nil then
		OnReceiveDealCards(cacheData.DealCards)
	end
end

local OnReceiveGameComplete = function()
	cacheData = {}
	gameStage = GameStage.WaitStart
	Global.Data.User.GameData.Clear()
	EventManager:TriggerEvent(Global.Event.GameComplete, nil)
	--服务端会发送一个桌子信息变更的消息
end

local AddListener = function()
	ui.gameBtn:AddListener()
	ui.chairList:AddListener()
	ui.identityChoose:AddListener()
	ui.characterChoose:AddListener()
	EventManager:AddListener(Global.Event.IdentityChooseComplete, OnIdentityChooseComplete, "Lua.game.OnIdentityChooseComplete")
	EventManager:AddListener(Global.Event.CharacterChooseComplete, OnCharacterChooseComplete, "Lua.game.OnCharacterChooseComplete")
	ProtosManager:AddListener(Global.Protos.Cmd.ExitRoom_S2C, OnReceiveExitRoom, "Lua.game.OnReceiveExitRoom")
	ProtosManager:AddListener(Global.Protos.Cmd.RoomInfoChange_S2C, OnReceiveRoomInfoChange, "Lua.game.OnReceiveRoomInfoChange")
	ProtosManager:AddListener(Global.Protos.Cmd.RequestRoomInfo_S2C, OnReceiveRequestRoomInfo, "Lua.game.OnReceiveRequestRoomInfo")
	ProtosManager:AddListener(Global.Protos.Cmd.ReadyStatus_S2C, OnReceiveReadyStatus, "Lua.game.OnReceiveReadyStatus")
	ProtosManager:AddListener(Global.Protos.Cmd.GameStart_S2C, OnReceiveGameStart, "Lua.game.OnReceiveGameStart")
	ProtosManager:AddListener(Global.Protos.Cmd.Identity_S2C, OnReceiveIdentity, "Lua.game.OnReceiveIdentity")
	ProtosManager:AddListener(Global.Protos.Cmd.CharacterChooseList_S2C, OnReceiveCharacterChooseList, "Lua.game.OnReceiveCharacterChooseList")
	ProtosManager:AddListener(Global.Protos.Cmd.GameComplete_S2C, OnReceiveGameComplete, "Lua.game.OnReceiveGameComplete")
	ProtosManager:AddListener(Global.Protos.Cmd.DealCards_S2C, OnReceiveDealCards, "Lua.game.OnReceiveDealCards")
end

local RemoveListener = function()
	ui.gameBtn:RemoveListener()
	ui.chairList:RemoveListener()
	ui.identityChoose:RemoveListener()
	ui.characterChoose:RemoveListener()
	EventManager:RemoveListener(Global.Event.IdentityChooseComplete, OnIdentityChooseComplete)
	EventManager:RemoveListener(Global.Event.CharacterChooseComplete, OnCharacterChooseComplete)
	ProtosManager:RemoveListener(Global.Protos.Cmd.ExitRoom_S2C, OnReceiveExitRoom)
	ProtosManager:RemoveListener(Global.Protos.Cmd.RoomInfoChange_S2C, OnReceiveRoomInfoChange)
	ProtosManager:RemoveListener(Global.Protos.Cmd.RequestRoomInfo_S2C, OnReceiveRequestRoomInfo)
	ProtosManager:RemoveListener(Global.Protos.Cmd.ReadyStatus_S2C, OnReceiveReadyStatus)
	ProtosManager:RemoveListener(Global.Protos.Cmd.GameStart_S2C, OnReceiveGameStart)
	ProtosManager:RemoveListener(Global.Protos.Cmd.Identity_S2C, OnReceiveIdentity)
	ProtosManager:RemoveListener(Global.Protos.Cmd.CharacterChooseList_S2C, OnReceiveCharacterChooseList)
	ProtosManager:RemoveListener(Global.Protos.Cmd.GameComplete_S2C, OnReceiveGameComplete)
	ProtosManager:RemoveListener(Global.Protos.Cmd.DealCards_S2C, OnReceiveDealCards)
end

local RequestRoomInfo = function()
	local data = {}
	data.roomNub = Global.Data.RoomInfo.RoomNub
	local dataBytes = Global.Protos.Methods.Lua2Bytes(Global.Protos.FileName.Room, Global.Protos.Class.RequestRoomInfo_C2S, data)
	NetManager:Send(Global.Login.Network, Global.Protos.Cmd.RequestRoomInfo_C2S, dataBytes)
end

local Dispose = function()
	ui.gameBtn:Dispose()
	ui.chairList:Dispose()
	ui.identityChoose:Dispose()
	ui.characterChoose:Dispose()
	
	cacheData = {}
	Global.Data.User.GameData.Clear()
end

function awake()
	InitUIReference()
end

function onenable()
	InitUI()
	AddUIEvent()
	AddListener()
	
	RequestRoomInfo()
	gameStage = GameStage.WaitStart
end

function ondisable()
	RemoveUIEvent()
	RemoveListener()
	Dispose()
end

function ondestroy()
	RemoveUIEvent()
	RemoveListener()
	Dispose()
end