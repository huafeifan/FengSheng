require "ui/login/userHead"

Chair = {}
Chair.__index = Chair

function Chair:New(gameObject)
	local item = {}
	item.gameObject = gameObject
	item.transform = gameObject.transform
	item.ui = {}

	setmetatable(item, Chair)
	return item
end

function Chair:InitUIReference()
	self.ui.ready = self.transform:Find("Ready")
	self.ui.owener = self.transform:Find("Owener")
	self.ui.character = {}
	self.ui.character.transform = self.transform:Find("User/Character")
	self.ui.character.btn = self.ui.character.transform:GetComponent(typeof(Button))
	self.ui.character.image = self.ui.character.transform:GetComponent(typeof(Image))
	self.ui.character.bigerBtn = self.ui.character.transform:Find("BigerBtn"):GetComponent(typeof(Button))
	self.ui.character.defaultLocalPos = self.ui.character.transform.localPosition
	self.ui.character.defaultScale = self.ui.character.transform.localScale
	self.ui.character.worldPosZero = self.ui.character.transform:Find("WorldPositionZero").localPosition
	
	self.ui.head = UserHead:New(self.transform:Find("User").gameObject)
	self.ui.head:InitUIReference()
end

function Chair:InitUI()
	self.gameObject:SetActive(true)
	self.ui.ready.gameObject:SetActive(false)
	self.ui.owener.gameObject:SetActive(false)
	self.ui.character.bigerBtn.gameObject:SetActive(false)
	self:ShowHead()
	self.ui.head:SetData("")
end

function Chair:SetChairInfo(chairInfo)
	self.chairInfo = chairInfo
	
	if chairInfo.isNull == false then
		self.ui.owener.gameObject:SetActive(chairInfo.chairNub == 1)
		self.ui.ready.gameObject:SetActive(chairInfo.chairNub ~= 1 and chairInfo.isReady == true)
		if chairInfo.userData == nil then
			self.ui.head:SetData("")
		else
			self.ui.head:SetData(chairInfo.userData.name)
		end
		
	else
		self:InitUI()
	end
	
end

function Chair:SetCharacter(character)
	self.ui.character.bigerBtn.gameObject:SetActive(true)
	self.ui.character.image.sprite = ResourcesManager:LoadSprite(Global.Resources.Character[character])
end

function Chair:HideStatus()
	self.ui.ready.gameObject:SetActive(false)
	self.ui.owener.gameObject:SetActive(false)
end

function Chair:ShowCharacter()
	self.ui.head:SetHeadActive(false)
	self.ui.character.transform.gameObject:SetActive(true)
	self.ui.character.image.sprite = ResourcesManager:LoadSprite(Global.Resources.Character[CharacterType.None])
	self.ui.character.bigerBtn.gameObject:SetActive(false)
end

function Chair:ShowHead()
	self.ui.head:SetHeadActive(true)
	self.ui.character.transform.gameObject:SetActive(false)
end

function Chair:GetUserData()
	if self.chairInfo == nil then
		return nil
	else
		return self.chairInfo.userData
	end
end

function Chair:GetCharacterPos()
	return self.ui.character.transform.position
end

function Chair:IsOwner()
	if self.chairInfo == nil then
		return false
	end
	
	if self.chairInfo.isNull == true then
		return false
	end
	
	return self.chairInfo.chairNub == 1
end

function Chair:IsReady()
	if self.chairInfo == nil then
		return false
	end

	if self.chairInfo.isNull == true then
		return false
	end
	
	return self.chairInfo.isReady
end

function Chair:OnBtnCharacter()
	
end

function Chair:OnBtnCharacterBiger()
	local Step1, Step2, Step3 = nil, nil, nil
	Step1 = function()
		self.ui.character.transform:DOLocalMove(self.ui.character.worldPosZero, 0.2)
		self.ui.character.transform:DOScale(Vector3.one * 2.5, 0.2):OnComplete(Step2)
	end

	Step2 = function()
		self.ui.character.transform:DOLocalMove(self.ui.character.defaultLocalPos, 0.2):SetDelay(1)
		self.ui.character.transform:DOScale(self.ui.character.defaultScale, 0.2):SetDelay(1):OnComplete(Step3)
	end

	Step3 = function()
		self.ui.character.bigerBtn.gameObject:SetActive(true)
	end
	
	self.ui.character.bigerBtn.gameObject:SetActive(false)
	self.ui.character.transform.localPosition = self.ui.character.defaultLocalPos
	self.ui.character.transform.localScale = self.ui.character.defaultScale
	Step1()
end

function Chair:AddUIEvent()
	self.ui.head:AddUIEvent()
	UIEventManager:AddListener(self.ui.character.btn, self.OnBtnCharacter, self, "lua.game.chair.OnBtnCharacter")
	UIEventManager:AddListener(self.ui.character.bigerBtn, self.OnBtnCharacterBiger, self, "lua.game.chair.OnBtnCharacterBiger")
end

function Chair:RemoveUIEvent()
	self.ui.head:RemoveUIEvent()
	UIEventManager:RemoveAllListeners(self.ui.character.btn)
	UIEventManager:RemoveAllListeners(self.ui.character.bigerBtn)
end

function Chair:OnReceiveGameStart()
	self.ui.ready.gameObject:SetActive(false)
	self.ui.owener.gameObject:SetActive(false)
end

function Chair:AddListener()
	self.ui.head:AddListener()
end

function Chair:RemoveListener()
	self.ui.head:RemoveListener()
end

function Chair:Dispose()
	if self.ui.head ~= nil then
		self.ui.head:Dispose()
	end
end