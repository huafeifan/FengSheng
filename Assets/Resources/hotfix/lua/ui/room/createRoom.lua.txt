local ui = {}
local roomData = {}

local InitUIReference = function()
	ui.closeBtn = self.transform:Find("CloseBtn"):GetComponent(typeof(Button))
	ui.createRoomBtn = self.transform:Find("CreateBtn"):GetComponent(typeof(Button))
	ui.inputRoomName = self.transform:Find("RoomName/InputBg"):GetComponent(typeof(InputField))
	ui.chair3 = self.transform:Find("ChairCount/Item3/Toggle"):GetComponent(typeof(Toggle))
	ui.chair4 = self.transform:Find("ChairCount/Item4/Toggle"):GetComponent(typeof(Toggle))
	ui.chair5 = self.transform:Find("ChairCount/Item5/Toggle"):GetComponent(typeof(Toggle))
	ui.chair6 = self.transform:Find("ChairCount/Item6/Toggle"):GetComponent(typeof(Toggle))
end

local InitUI = function()
	local defaultRoomName = "哦嗨哟,快来一起玩吧"
	ui.chair3.isOn = true
	ui.inputRoomName.text = defaultRoomName
	roomData.chairCount = 3
	roomData.roomName = defaultRoomName
end

local OnBtnClose = function()
	Global.Methods.PlayBtnAnimation(ui.closeBtn)
	UIManager:CloseUI(Global.CreateRoomPrefab_Path)
end

local CheckInputRoomName = function(s)
	if s == nil or string.len(s) <= 0 then
		Global.Methods.ShowTips("请输入房間名称")
		return false
	end

	return true
end

local OnBtnCreate = function()
	Global.Methods.PlayBtnAnimation(ui.createRoomBtn)
	if CheckInputRoomName(roomData.roomName) == true then
		local dataBytes = Global.Protos.Methods.Lua2Bytes(Global.Protos.FileName.Room, Global.Protos.Class.CreateRoom_C2S, roomData)
		NetManager:Send(Global.Login.Network, Global.Protos.Cmd.CreateRoom_C2S, dataBytes)
	end
end

local OnInputRoomNameChanged = function(s)
	roomData.roomName = s
end

local OnChair3ToggleChanged = function(b)
	if b == true then
		roomData.chairCount = 3
	end
end
	
local OnChair4ToggleChanged = function(b)
	if b == true then
		roomData.chairCount = 4
	end
end

local OnChair5ToggleChanged = function(b)
	if b == true then
		roomData.chairCount = 5
	end
end

local OnChair6ToggleChanged = function(b)
	if b == true then
		roomData.chairCount = 6
	end
end

local AddUIEvent = function()
	UIEventManager:AddListener(ui.closeBtn, OnBtnClose, "lua.createRoom.OnBtnClose")
	UIEventManager:AddListener(ui.createRoomBtn, OnBtnCreate, "lua.createRoom.OnBtnCreate")
	UIEventManager:AddListener(ui.inputRoomName, OnInputRoomNameChanged, "lua.createRoom.OnInputRoomNameChanged")
	UIEventManager:AddListener(ui.createRoomBtn, OnBtnCreate, "lua.createRoom.OnBtnCreate")
	UIEventManager:AddListener(ui.chair3, OnChair3ToggleChanged, "lua.createRoom.OnChair3ToggleChanged")
	UIEventManager:AddListener(ui.chair4, OnChair4ToggleChanged, "lua.createRoom.OnChair4ToggleChanged")
	UIEventManager:AddListener(ui.chair5, OnChair5ToggleChanged, "lua.createRoom.OnChair5ToggleChanged")
	UIEventManager:AddListener(ui.chair6, OnChair6ToggleChanged, "lua.createRoom.OnChair6ToggleChanged")
end

local RemoveUIEvent = function()
	UIEventManager:RemoveAllListeners(ui.closeBtn)
	UIEventManager:RemoveAllListeners(ui.createRoomBtn)
	UIEventManager:RemoveAllListeners(ui.inputRoomName)
	UIEventManager:RemoveAllListeners(ui.chair3)
	UIEventManager:RemoveAllListeners(ui.chair4)
	UIEventManager:RemoveAllListeners(ui.chair5)
	UIEventManager:RemoveAllListeners(ui.chair6)
end

local OnReceiveCreateRoom = function(bytes)
	local data = Global.Protos.Methods.Bytes2Lua(Global.Protos.FileName.Room, Global.Protos.Class.CreateRoom_S2C, bytes)

	if data.code == "Success" then
		UIManager:CloseUI(Global.CreateRoomPrefab_Path)
	else
		Global.Methods.ShowTips(data.msg)
	end
end

local AddListener = function()
	ProtosManager:AddListener(Global.Protos.Cmd.CreateRoom_S2C, OnReceiveCreateRoom, "Lua.createRoom.OnReceiveCreateRoom")
end

local RemoveListener = function()
	ProtosManager:RemoveListener(Global.Protos.Cmd.CreateRoom_S2C, OnReceiveCreateRoom)
end

function awake()
	InitUIReference()
end

function onenable()
	InitUI()
	AddUIEvent()
	AddListener()
end

function ondisable()
	RemoveUIEvent()
	RemoveListener()
end

function ondestroy()
	RemoveUIEvent()
	RemoveListener()
end